<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Tokens List</title>
  <link rel="stylesheet" href="./style.css">
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <style>
    body{font-family:Arial,sans-serif;padding:20px;background:#fafafa}
    .top{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
    input{padding:8px;width:260px;max-width:100%}
    button{padding:8px 12px;cursor:pointer}
    #list{margin-top:14px;max-width:960px}
    .card{padding:14px;border:1px solid #e6e6e6;border-radius:8px;margin-bottom:12px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,0.03);display:flex;justify-content:space-between;align-items:flex-start}
    .left{line-height:1.6;max-width:70%}
    .tokenLine{font-size:18px;font-weight:600}
    .tokenBig{font-size:22px;color:#1a73e8}
    .muted{color:#666;font-size:13px}
    .actions button{margin-left:6px;margin-top:4px}
    .empty{color:#666}
  </style>
</head>
<body>

<h2>Issued Tokens</h2>

<div class="top">
  <input id="hospitalIdInput" placeholder="Hospital ID eg HOSP1">
  <input id="dateInput" type="date">
  <button id="loadBtn">Load Tokens</button>
</div>

<div id="list"></div>

<script>
  var firebaseConfig = {
    apiKey: "AIzaSyAJnlrtazUWr_HjQiEkFNcbnsve73g1pEQ",
    authDomain: "smart-opd-69488.firebaseapp.com",
    projectId: "smart-opd-69488",
    storageBucket: "smart-opd-69488.firebasestorage.app",
    messagingSenderId: "373276983810",
    appId: "1:373276983810:web:88a3018ab7b811550d1d1b"
  };
  firebase.initializeApp(firebaseConfig);
  var db = firebase.firestore();

  function todayString(){
    var d = new Date();
    return d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0") + "-" + String(d.getDate()).padStart(2,"0");
  }

  function pad(n){ return String(n).padStart(2,"0"); }

  function formatTime(h,m){
    var ap = h >= 12 ? "PM" : "AM";
    var hh = h % 12 === 0 ? 12 : h % 12;
    return hh + ":" + pad(m) + " " + ap;
  }

  function computeSlotAndWindow(tokenNumber, maxPerDay){
    var perSlot = Math.max(1, Math.ceil(maxPerDay / 3));
    var idx = tokenNumber - 1;
    var slotIndex = Math.floor(idx / perSlot);
    var slotStartHour = 9 + slotIndex;  
    var posInSlot = idx % perSlot;
    var minutesPerToken = Math.max(1, Math.floor(60 / perSlot));
    var startMinute = posInSlot * minutesPerToken;
    var endMinuteOffset = startMinute + minutesPerToken;
    var endHour = slotStartHour + Math.floor(endMinuteOffset / 60);
    var endMin = endMinuteOffset % 60;

    var start = formatTime(slotStartHour, startMinute);
    var end = formatTime(endHour, endMin === 0 ? 0 : endMin);
    var fallbackAfter = Math.max(1, Math.floor(perSlot / 2));

    return {
      window: start + " to " + end,
      fallbackAfter: fallbackAfter
    };
  }

  function sortByIssuedAt(arr){
    arr.sort(function(a,b){
      var ta = 0;
      var tb = 0;
      if(a.issuedAt && a.issuedAt.toMillis) ta = a.issuedAt.toMillis();
      else if(a.issuedAt) ta = new Date(a.issuedAt).getTime();
      if(b.issuedAt && b.issuedAt.toMillis) tb = b.issuedAt.toMillis();
      else if(b.issuedAt) tb = new Date(b.issuedAt).getTime();
      return ta - tb;
    });
  }

  function renderList(docs, maxPerDay){
    var list = document.getElementById("list");
    list.innerHTML = "";
    if(!docs || docs.length === 0){
      var p = document.createElement("div");
      p.className = "empty";
      p.innerText = "No tokens found";
      list.appendChild(p);
      return;
    }

    docs.forEach(function(entry){
      var tokenNum = entry.tokenNumber || 0;
      if(tokenNum <= 0) return;

      var slotInfo = computeSlotAndWindow(tokenNum, maxPerDay);

      var card = document.createElement("div");
      card.className = "card";

      var left = document.createElement("div");
      left.className = "left";

      var line1 = document.createElement("div");
      line1.className = "tokenLine";
      line1.innerHTML = "Token Number " + "<span class='tokenBig'>" + tokenNum + "</span>";

      var line2 = document.createElement("div");
      line2.className = "muted";
      line2.innerText = "Visiting time is " + slotInfo.window;

      var line3 = document.createElement("div");
      line3.className = "muted";
      line3.innerText = "on missing the chance at the given time you will be called again after " + slotInfo.fallbackAfter + " patients";

      var line4 = document.createElement("div");
      line4.className = "muted";
      line4.innerText = "Date " + (entry.date || todayString());

      left.appendChild(line1);
      left.appendChild(line2);
      left.appendChild(line3);
      left.appendChild(line4);

      var actions = document.createElement("div");
      actions.className = "actions";

      var statusSpan = document.createElement("div");
      statusSpan.className = "muted";
      statusSpan.innerText = "Status " + (entry.status || "Pending");

      var callBtn = document.createElement("button");
      callBtn.innerText = "Call";
      callBtn.onclick = function(){
        db.collection("tokens").doc(entry._id).update({ status: "Called" })
          .catch(function(e){ alert(e.message); });
      };

      var checkBtn = document.createElement("button");
      checkBtn.innerText = "Checked In";
      checkBtn.onclick = function(){
        db.collection("tokens").doc(entry._id).update({ status: "Checked In" })
          .catch(function(e){ alert(e.message); });
      };

      var delBtn = document.createElement("button");
      delBtn.innerText = "Delete";
      delBtn.onclick = function(){
        if(confirm("Delete token " + tokenNum + ""))
          db.collection("tokens").doc(entry._id).delete().catch(function(e){ alert(e.message); });
      };

      actions.appendChild(statusSpan);
      actions.appendChild(callBtn);
      actions.appendChild(checkBtn);
      actions.appendChild(delBtn);

      card.appendChild(left);
      card.appendChild(actions);

      list.appendChild(card);
    });
  }

  function loadTokensOnce(hospitalId, dateStr){
    if(!hospitalId){ alert("Enter hospital ID"); return; }
    if(!dateStr) dateStr = todayString();

    db.collection("hospitals").where("hospitalId","==",hospitalId).get()
      .then(function(hsnap){
        var maxPerDay = 60;
        if(!hsnap.empty){
          var hdata = hsnap.docs[0].data();
          if(hdata.maxPerDay) maxPerDay = hdata.maxPerDay;
        }
        return db.collection("tokens")
          .where("hospitalId","==",hospitalId)
          .where("date","==",dateStr)
          .get()
          .then(function(snap){
            var arr = [];
            snap.forEach(function(doc){
              var d = doc.data();
              d._id = doc.id;
              arr.push(d);
            });
            sortByIssuedAt(arr);
            renderList(arr, maxPerDay);
          });
      })
      .catch(function(err){
        alert("Error " + err.message);
      });
  }

  document.addEventListener("DOMContentLoaded", function(){
    document.getElementById("dateInput").value = todayString();

    document.getElementById("loadBtn").addEventListener("click", function(){
      var hid = document.getElementById("hospitalIdInput").value.trim();
      var d = document.getElementById("dateInput").value;
      loadTokensOnce(hid, d);
    });
  });
</script>

</body>
</html>
