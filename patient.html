<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Patient Portal</title>
  <link rel="stylesheet" href="./style.css">
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>

<h2>Patient Portal</h2>

<div id="authArea">
  <h3>Signup</h3>
  <input id="pname" placeholder="Full name">
  <input id="pemail" placeholder="Email">
  <input id="ppass" type="password" placeholder="Password">
  <button id="signupBtn">Signup</button>

  <hr>

  <h3>Login</h3>
  <input id="pemail2" placeholder="Email">
  <input id="ppass2" type="password" placeholder="Password">
  <button id="loginBtn">Login</button>
</div>

<div id="afterLogin" style="display:none">
  <p id="loggedText">You are logged in. Scan hospital QR to get token.</p>
  <video id="video" style="width:320px;height:auto;border:1px solid #ccc"></video>
  <canvas id="canvas" style="display:none"></canvas>
  <div style="margin-top:12px">
    <button id="scanBtn">Scan QR and get token</button>
    <button id="logoutBtn">Logout</button>
  </div>
</div>

<script>
  var firebaseConfig = {
  apiKey: "AIzaSyAJnlrtazUWr_HjQiEkFNcbnsve73g1pEQ",
  authDomain: "smart-opd-69488.firebaseapp.com",
  projectId: "smart-opd-69488",
  storageBucket: "smart-opd-69488.firebasestorage.app",
  messagingSenderId: "373276983810",
  appId: "1:373276983810:web:88a3018ab7b811550d1d1b",
  };
  firebase.initializeApp(firebaseConfig);
  var auth = firebase.auth();
  var db = firebase.firestore();

  function todayString(){
    var d = new Date();
    return d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0") + "-" + String(d.getDate()).padStart(2,"0");
  }

  function signup(){
    var name = document.getElementById("pname").value.trim();
    var email = document.getElementById("pemail").value.trim();
    var pass = document.getElementById("ppass").value;
    if(!name || !email || !pass){ alert("Fill all fields"); return; }
    auth.createUserWithEmailAndPassword(email, pass)
      .then(function(cred){
        return db.collection("patients").add({
          uid: cred.user.uid,
          name: name,
          email: email,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      })
      .then(function(){
        alert("Signup done. Login now");
      })
      .catch(function(err){
        alert(err.message);
      });
  }

  function login(){
    var email = document.getElementById("pemail2").value.trim();
    var pass = document.getElementById("ppass2").value;
    if(!email || !pass){ alert("Fill login fields"); return; }
    auth.signInWithEmailAndPassword(email, pass)
      .catch(function(err){
        alert(err.message);
      });
  }

  function logout(){
    auth.signOut().catch(function(){});
  }

  function issueTokenFor(hospitalId){
    var user = auth.currentUser;
    if(!user){ alert("Login first"); return; }
    var dateStr = todayString();
    db.collection("tokens").where("hospitalId","==",hospitalId).where("date","==",dateStr).get()
      .then(function(snap){
        var count = snap.size;
        var max = 60;
        if(count >= max){
          alert("All appointments full");
          return;
        }
        var token = count + 1;
        var slot;
        if(token <= 20) slot = "09:00 to 10:00";
        else if(token <= 40) slot = "10:00 to 11:00";
        else slot = "11:00 to 12:00";
        return db.collection("tokens").add({
          hospitalId: hospitalId,
          uid: user.uid,
          tokenNumber: token,
          date: dateStr,
          slot: slot,
          issuedAt: firebase.firestore.FieldValue.serverTimestamp(),
          status: "Pending"
        }).then(function(){
          alert("Your token is T" + token + " for slot " + slot);
        });
      })
      .catch(function(err){
        alert(err.message);
      });
  }

  function startScan(){
    var video = document.getElementById("video");
    var canvas = document.getElementById("canvas");
    var ctx = canvas.getContext("2d");
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(function(stream){
        video.srcObject = stream;
        video.play();
        function scanLoop(){
          if(video.readyState === video.HAVE_ENOUGH_DATA){
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video,0,0,canvas.width,canvas.height);
            var img = ctx.getImageData(0,0,canvas.width,canvas.height);
            var code = jsQR(img.data,img.width,img.height);
            if(code){
              try{
                var data = JSON.parse(code.data);
                if(data.hospitalId){
                  stream.getTracks().forEach(function(t){ t.stop(); });
                  issueTokenFor(data.hospitalId);
                  return;
                }
              }catch(e){}
            }
          }
          requestAnimationFrame(scanLoop);
        }
        scanLoop();
      })
      .catch(function(err){
        alert(err.message);
      });
  }

  document.addEventListener("DOMContentLoaded", function(){
    document.getElementById("signupBtn").addEventListener("click", signup);
    document.getElementById("loginBtn").addEventListener("click", login);
    document.getElementById("logoutBtn").addEventListener("click", logout);
    document.getElementById("scanBtn").addEventListener("click", startScan);
  });

  auth.onAuthStateChanged(function(user){
    var authArea = document.getElementById("authArea");
    var after = document.getElementById("afterLogin");
    if(user){
      authArea.style.display = "none";
      after.style.display = "block";
    }else{
      authArea.style.display = "block";
      after.style.display = "none";
    }
  });
</script>

</body>
</html>
